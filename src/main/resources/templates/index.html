<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æ–‡æ¡£è§£ææœåŠ¡</title>
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ“„</text></svg>"
    />
    <style>
      /* è‡ªå®šä¹‰å­—ä½“å®šä¹‰ */
      @font-face {
        font-family: "1666963922";
        src: url("https://jsd.cdn.zzko.cn/gh/54ayao/ACG@main/static/fonts/1666963922.woff")
          format("woff");
        font-weight: normal;
        font-style: normal;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "1666963922", -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, "Helvetica Neue", Arial, sans-serif;
        background-image: url("https://ipgeo-bingpic.hf.space");
        background-attachment: fixed;
        background-size: cover;
        background-position: center center;
        background-repeat: no-repeat;
        min-height: 100vh;
        color: #333;
        overflow-x: hidden;
      }

      /* èƒŒæ™¯é®ç½©å±‚ */
      body::before {
        content: "";
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.2);
        z-index: 0;
      }

      .container {
        position: relative;
        z-index: 1;
        max-width: 1400px;
        margin: 0 auto;
        padding: 40px 20px;
      }

      /* Header */
      header {
        text-align: center;
        margin-bottom: 40px;
        color: white;
      }

      header h1 {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 10px;
        background-image: linear-gradient(
          90deg,
          #07c160,
          #fb6bea 25%,
          #3aedff 50%,
          #fb6bea 75%,
          #28d079
        );
        -webkit-text-fill-color: transparent;
        -webkit-background-clip: text;
        background-clip: text;
        background-size: 400% 100%;
        animation: gradientMove 10s linear infinite;
      }

      header p {
        font-size: 1.1rem;
        color: white;
        text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      }

      header .author {
        margin-top: 10px;
        font-size: 0.95rem;
        background-image: linear-gradient(
          90deg,
          #07c160,
          #fb6bea 25%,
          #3aedff 50%,
          #fb6bea 75%,
          #28d079
        );
        -webkit-text-fill-color: transparent;
        -webkit-background-clip: text;
        background-clip: text;
        background-size: 400% 100%;
        animation: gradientMove 10s linear infinite;
      }

      @keyframes gradientMove {
        0% {
          background-position: 0% 50%;
        }
        50% {
          background-position: 100% 50%;
        }
        100% {
          background-position: 0% 50%;
        }
      }

      /* Main Layout */
      .main-layout {
        display: grid;
        grid-template-columns: 1fr 400px;
        gap: 30px;
        max-width: 1400px;
        margin: 0 auto;
      }

      /* Liquid Glass Effect - SVG Filter */
      svg.filters {
        position: absolute;
        width: 0;
        height: 0;
      }

      /* Glass Card Base */
      .glass-card {
        position: relative;
        overflow: hidden;
        border-radius: 24px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
      }

      .glass-effect {
        position: absolute;
        z-index: 0;
        inset: 0;
        backdrop-filter: blur(10px);
        background: rgba(255, 255, 255, 0.15);
        filter: url(#glass-distortion);
      }

      .glass-tint {
        position: absolute;
        z-index: 1;
        inset: 0;
        background: rgba(255, 255, 255, 0.1);
      }

      .glass-shine {
        position: absolute;
        inset: 0;
        z-index: 2;
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 24px;
      }

      .glass-content {
        position: relative;
        z-index: 3;
        padding: 30px;
      }

      /* Upload Section */
      .upload-section {
        background: transparent;
      }

      .upload-area {
        border: 3px dashed rgba(255, 255, 255, 0.5);
        border-radius: 20px;
        padding: 50px 30px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        background: rgba(255, 255, 255, 0.1);
        margin-bottom: 20px;
      }

      .upload-area:hover {
        border-color: rgba(255, 255, 255, 0.8);
        background: rgba(255, 255, 255, 0.2);
        transform: translateY(-2px);
      }

      .upload-area.drag-over {
        border-color: #4ade80;
        background: rgba(74, 222, 128, 0.2);
      }

      .upload-icon {
        font-size: 3rem;
        margin-bottom: 15px;
      }

      .upload-text {
        color: white;
        font-size: 1.1rem;
        margin-bottom: 10px;
      }

      .upload-hint {
        color: rgba(255, 255, 255, 0.7);
        font-size: 0.9rem;
      }

      .file-input {
        display: none;
      }

      .upload-btn {
        background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
        color: white;
        border: none;
        padding: 15px 40px;
        border-radius: 12px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(74, 222, 128, 0.3);
      }

      .upload-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(74, 222, 128, 0.4);
      }

      .upload-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      /* Progress */
      .progress-section {
        margin-top: 20px;
        display: none;
      }

      .progress-section.active {
        display: block;
      }

      .progress-bar {
        height: 8px;
        background: rgba(255, 255, 255, 0.3);
        border-radius: 4px;
        overflow: hidden;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #4ade80, #22c55e);
        transition: width 0.3s ease;
        width: 0%;
      }

      .progress-text {
        color: white;
        margin-top: 10px;
        font-size: 0.9rem;
      }

      /* Result Section */
      .result-section {
        display: none;
        animation: fadeIn 0.5s ease;
      }

      .result-section.active {
        display: block;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .result-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .result-title {
        color: white;
        font-size: 1.5rem;
        font-weight: 600;
      }

      .result-actions {
        display: flex;
        gap: 10px;
      }

      .action-btn {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.3);
        padding: 10px 20px;
        border-radius: 10px;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .action-btn:hover {
        background: rgba(255, 255, 255, 0.3);
      }

      .tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
      }

      .tab {
        background: rgba(255, 255, 255, 0.15);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 10px;
        font-size: 0.95rem;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .tab.active {
        background: rgba(255, 255, 255, 0.3);
        font-weight: 600;
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }

      .markdown-preview {
        background: white;
        padding: 30px;
        border-radius: 16px;
        min-height: 400px;
        max-height: 700px;
        overflow-y: auto;
        line-height: 1.8;
      }

      .markdown-preview h1,
      .markdown-preview h2,
      .markdown-preview h3 {
        margin-top: 24px;
        margin-bottom: 16px;
        font-weight: 600;
      }

      .markdown-preview img {
        max-width: 100%;
        height: auto;
        border-radius: 8px;
        margin: 16px 0;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      }

      .markdown-source {
        background: #1e1e1e;
        color: #d4d4d4;
        padding: 20px;
        border-radius: 12px;
        font-family: "Consolas", "Monaco", monospace;
        font-size: 0.9rem;
        min-height: 400px;
        max-height: 700px;
        overflow: auto;
        white-space: pre-wrap;
        word-break: break-all;
      }

      /* Stats */
      .stats {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 15px;
        margin-bottom: 20px;
      }

      .stat-card {
        background: rgba(255, 255, 255, 0.15);
        padding: 15px;
        border-radius: 12px;
        text-align: center;
      }

      .stat-value {
        color: white;
        font-size: 1.8rem;
        font-weight: 700;
        margin-bottom: 5px;
      }

      .stat-label {
        color: rgba(255, 255, 255, 0.8);
        font-size: 0.85rem;
      }

      /* Responsive */
      @media (max-width: 1024px) {
        .main-layout {
          grid-template-columns: 1fr;
        }

        .history-panel {
          max-height: 400px;
        }
      }

      /* History Panel */
      .history-panel {
        background: transparent;
        max-height: 800px;
        overflow-y: auto;
      }

      .history-header {
        color: white;
        font-size: 1.3rem;
        font-weight: 600;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .history-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .history-item {
        background: rgba(255, 255, 255, 0.15);
        padding: 15px;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .history-item:hover {
        background: rgba(255, 255, 255, 0.25);
        transform: translateX(-3px);
      }

      .history-item.active {
        background: rgba(74, 222, 128, 0.3);
        border-color: rgba(74, 222, 128, 0.5);
      }

      .history-filename {
        color: white;
        font-size: 0.95rem;
        font-weight: 600;
        margin-bottom: 8px;
        word-break: break-all;
      }

      .history-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        color: rgba(255, 255, 255, 0.7);
        font-size: 0.8rem;
      }

      .history-time {
        flex: 1;
      }

      .history-actions {
        display: flex;
        gap: 8px;
      }

      .history-action-btn {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 6px;
        font-size: 0.75rem;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .history-action-btn:hover {
        background: rgba(255, 255, 255, 0.3);
      }

      .history-action-btn.delete {
        background: rgba(239, 68, 68, 0.3);
      }

      .history-action-btn.delete:hover {
        background: rgba(239, 68, 68, 0.5);
      }

      .history-empty {
        text-align: center;
        color: rgba(255, 255, 255, 0.6);
        padding: 40px 20px;
        font-size: 0.9rem;
      }

      /* Error */
      .error-msg {
        background: rgba(239, 68, 68, 0.2);
        border: 1px solid rgba(239, 68, 68, 0.5);
        color: white;
        padding: 15px;
        border-radius: 12px;
        margin-top: 15px;
        display: none;
      }

      .error-msg.active {
        display: block;
      }

      /* Config Section */
      .config-section {
        margin-bottom: 20px;
      }

      .config-header {
        color: white;
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .config-group {
        margin-bottom: 15px;
      }

      .config-label {
        color: rgba(255, 255, 255, 0.9);
        font-size: 0.9rem;
        margin-bottom: 8px;
        display: block;
      }

      .config-options {
        display: flex;
        gap: 10px;
      }

      .config-option {
        flex: 1;
        background: rgba(255, 255, 255, 0.15);
        border: 2px solid rgba(255, 255, 255, 0.2);
        color: white;
        padding: 10px 15px;
        border-radius: 10px;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
      }

      .config-option:hover {
        background: rgba(255, 255, 255, 0.25);
      }

      .config-option.active {
        background: rgba(74, 222, 128, 0.3);
        border-color: rgba(74, 222, 128, 0.6);
        font-weight: 600;
      }

      .config-hint {
        color: rgba(255, 255, 255, 0.6);
        font-size: 0.75rem;
        margin-top: 5px;
      }
    </style>
  </head>
  <body>
    <!-- SVG Filters for Liquid Glass Effect -->
    <svg class="filters">
      <filter id="glass-distortion" x="0%" y="0%" width="100%" height="100%">
        <feTurbulence
          type="fractalNoise"
          baseFrequency="0.01 0.01"
          numOctaves="1"
          seed="5"
          result="turbulence"
        />
        <feComponentTransfer in="turbulence" result="mapped">
          <feFuncR type="gamma" amplitude="1" exponent="10" offset="0.5" />
          <feFuncG type="gamma" amplitude="0" exponent="1" offset="0" />
          <feFuncB type="gamma" amplitude="0" exponent="1" offset="0.5" />
        </feComponentTransfer>
        <feGaussianBlur in="turbulence" stdDeviation="3" result="softMap" />
        <feSpecularLighting
          in="softMap"
          surfaceScale="5"
          specularConstant="1"
          specularExponent="100"
          lighting-color="white"
          result="specLight"
        >
          <fePointLight x="-200" y="-200" z="300" />
        </feSpecularLighting>
        <feComposite
          in="specLight"
          operator="arithmetic"
          k1="0"
          k2="1"
          k3="1"
          k4="0"
          result="litImage"
        />
        <feDisplacementMap
          in="SourceGraphic"
          in2="softMap"
          scale="150"
          xChannelSelector="R"
          yChannelSelector="G"
        />
      </filter>
    </svg>

    <div class="container">
      <!-- Header -->
      <header>
        <h1>æ–‡æ¡£è§£ææœåŠ¡</h1>
        <p>MinerU é©±åŠ¨ Â· æ–‡æ¡£è½¬ Markdown Â· GitHub å›¾åºŠ</p>
        <div class="author">Created by ZHONG WEI</div>
      </header>

      <div class="main-layout">
        <!-- Left: Main Content -->
        <div>
          <!-- Upload Section -->
          <div class="glass-card upload-section">
            <div class="glass-effect"></div>
            <div class="glass-tint"></div>
            <div class="glass-shine"></div>
            <div class="glass-content">
              <div class="upload-area" id="uploadArea">
                <div class="upload-text">æ‹–æ‹½æ–‡ä»¶åˆ°è¿™é‡Œæˆ–ç‚¹å‡»é€‰æ‹©</div>
                <div class="upload-hint">
                  æ”¯æŒ PDF, Word (.doc/.docx), PPT (.ppt/.pptx)
                </div>
                <input
                  type="file"
                  id="fileInput"
                  class="file-input"
                  accept=".pdf,.doc,.docx,.ppt,.pptx"
                />
              </div>

              <div id="fileInfo" style="display: none">
                <div
                  style="color: white; margin-bottom: 15px; text-align: center"
                >
                  å·²é€‰æ‹©: <strong id="fileName"></strong> (<span
                    id="fileSize"
                  ></span
                  >)
                </div>
                <div style="text-align: center">
                  <button
                    class="upload-btn"
                    id="startParseBtn"
                    onclick="uploadFile()"
                  >
                    å¼€å§‹è§£æ
                  </button>
                </div>
              </div>

              <div class="progress-section" id="progressSection">
                <div class="progress-bar">
                  <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text" id="progressText">
                  æ­£åœ¨è§£ææ–‡æ¡£...
                </div>
              </div>

              <div class="error-msg" id="errorMsg"></div>
            </div>
          </div>

          <!-- Result Section -->
          <div
            class="glass-card result-section"
            id="resultSection"
            style="margin-top: 30px"
          >
            <div class="glass-effect"></div>
            <div class="glass-tint"></div>
            <div class="glass-shine"></div>
            <div class="glass-content">
              <div class="result-header">
                <div class="result-title">è§£æç»“æœ</div>
                <div class="result-actions">
                  <button class="action-btn" onclick="copyMarkdown()">
                    å¤åˆ¶
                  </button>
                  <button class="action-btn" onclick="downloadMarkdown()">
                    ä¸‹è½½
                  </button>
                </div>
              </div>

              <div class="stats">
                <div class="stat-card">
                  <div class="stat-value" id="imageCount">0</div>
                  <div class="stat-label">å›¾ç‰‡æ•°é‡</div>
                </div>
                <div class="stat-card">
                  <div class="stat-value" id="processingTime">0s</div>
                  <div class="stat-label">å¤„ç†æ—¶é—´</div>
                </div>
                <div class="stat-card">
                  <div class="stat-value" id="fileNameDisplay">-</div>
                  <div class="stat-label">æ–‡ä»¶å</div>
                </div>
              </div>

              <div class="tabs">
                <button class="tab active" onclick="switchTab('preview')">
                  é¢„è§ˆ
                </button>
                <button class="tab" onclick="switchTab('source')">æºç </button>
              </div>

              <div class="tab-content active" id="previewTab">
                <div class="markdown-preview" id="markdownPreview"></div>
              </div>

              <div class="tab-content" id="sourceTab">
                <div class="markdown-source" id="markdownSource"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Right: History Panel -->
        <div>
          <!-- Config Section -->
          <div class="glass-card config-section">
            <div class="glass-effect"></div>
            <div class="glass-tint"></div>
            <div class="glass-shine"></div>
            <div class="glass-content">
              <div class="config-header">âš™ï¸ é…ç½®é€‰é¡¹</div>

              <!-- è§£æå™¨é€‰æ‹© -->
              <div class="config-group">
                <label class="config-label">è§£æå™¨ç±»å‹</label>
                <div class="config-options">
                  <div
                    class="config-option"
                    data-parser="mineru"
                    onclick="selectParser('mineru')"
                  >
                    MinerU
                  </div>
                  <div
                    class="config-option"
                    data-parser="aliyun"
                    onclick="selectParser('aliyun')"
                  >
                    é˜¿é‡Œäº‘
                  </div>
                </div>
              

              <!-- å­˜å‚¨æ–¹å¼é€‰æ‹© -->
              <div class="config-group">
                <label class="config-label">å›¾ç‰‡å­˜å‚¨æ–¹å¼</label>
                <div class="config-options">
                  <div
                    class="config-option"
                    data-storage="github"
                    onclick="selectStorage('github')"
                  >
                    GitHub
                  </div>
                  <div
                    class="config-option"
                    data-storage="oss"
                    onclick="selectStorage('oss')"
                  >
                    é˜¿é‡Œäº‘OSS
                  </div>
                </div>
   
            </div>
          </div>

          <!-- History Panel -->
          <div class="glass-card history-panel" style="margin-top: 20px">
            <div class="glass-effect"></div>
            <div class="glass-tint"></div>
            <div class="glass-shine"></div>
            <div class="glass-content">
              <div class="history-header">ğŸ“š è§£æå†å²</div>
              <div class="history-list" id="historyList">
                <div class="history-empty">æš‚æ— è§£æè®°å½•</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Marked.js for Markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script>
      // Configure marked
      marked.setOptions({
        breaks: true,
        gfm: true,
        headerIds: true,
        mangle: false,
        sanitize: false,
      });

      let currentMarkdown = "";
      let currentFilename = "";
      let currentHistoryId = null;
      let currentConfig = {
        parserType: "mineru",
        imageStorage: "github",
      };

      // é¡µé¢åŠ è½½æ—¶è·å–å†å²è®°å½•å’Œé…ç½®
      window.addEventListener("load", function () {
        loadConfig();
        loadHistoryList();
      });

      // åŠ è½½å†å²è®°å½•åˆ—è¡¨
      async function loadHistoryList() {
        try {
          const response = await fetch("/api/document/history");
          const result = await response.json();

          if (result.code === 200 && result.data && result.data.length > 0) {
            renderHistoryList(result.data);
          } else {
            document.getElementById("historyList").innerHTML =
              '<div class="history-empty">æš‚æ— è§£æè®°å½•</div>';
          }
        } catch (error) {
          console.error("åŠ è½½å†å²è®°å½•å¤±è´¥:", error);
        }
      }

      // æ¸²æŸ“å†å²è®°å½•åˆ—è¡¨
      function renderHistoryList(histories) {
        const historyList = document.getElementById("historyList");

        if (histories.length === 0) {
          historyList.innerHTML =
            '<div class="history-empty">æš‚æ— è§£æè®°å½•</div>';
          return;
        }

        historyList.innerHTML = histories
          .map(
            (history) => `
                <div class="history-item" data-id="${
                  history.id
                }" onclick="viewHistory(${history.id})">
                    <div class="history-filename">${escapeHtml(
                      history.originalFilename
                    )}</div>
                    <div class="history-meta">
                        <div style="flex: 1;">
                            <div class="history-time">${formatTime(
                              history.createdAt
                            )}</div>
                            <div style="font-size: 0.75rem; color: rgba(255, 255, 255, 0.7); margin-top: 3px;">
                                ${getParserName(
                                  history.parserType
                                )} | ${getStorageName(history.imageStorage)}
                            </div>
                        </div>
                        <div class="history-actions" onclick="event.stopPropagation()">
                            <button class="history-action-btn delete" onclick="deleteHistory(${
                              history.id
                            })">åˆ é™¤</button>
                        </div>
                    </div>
                </div>
            `
          )
          .join("");
      }

      // è·å–è§£æå™¨å›¾æ ‡
      function getParserIcon(parserType) {
        if (parserType === "mineru") {
          return "ğŸ”§";
        } else if (parserType === "aliyun") {
          return "â˜ï¸";
        }
        return "ğŸ“„";
      }

      // è·å–è§£æå™¨åç§°
      function getParserName(parserType) {
        if (parserType === "mineru") {
          return "MinerU";
        } else if (parserType === "aliyun") {
          return "é˜¿é‡Œäº‘";
        }
        return "æœªçŸ¥";
      }

      // è·å–å­˜å‚¨æ–¹å¼å›¾æ ‡
      function getStorageIcon(imageStorage) {
        if (imageStorage === "github") {
          return "ğŸ™";
        } else if (imageStorage === "oss") {
          return "ğŸ’¾";
        }
        return "ğŸ“¦";
      }

      // è·å–å­˜å‚¨æ–¹å¼åç§°
      function getStorageName(imageStorage) {
        if (imageStorage === "github") {
          return "GitHub";
        } else if (imageStorage === "oss") {
          return "OSS";
        }
        return "æœªçŸ¥";
      }

      // æŸ¥çœ‹å†å²è®°å½•è¯¦æƒ…
      async function viewHistory(id) {
        try {
          // æ›´æ–°é€‰ä¸­çŠ¶æ€
          document.querySelectorAll(".history-item").forEach((item) => {
            item.classList.remove("active");
          });
          event.currentTarget.classList.add("active");

          currentHistoryId = id;

          // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
          document.getElementById("progressSection").classList.add("active");
          document.getElementById("progressText").textContent =
            "æ­£åœ¨åŠ è½½å†å²è®°å½•...";

          const response = await fetch(`/api/document/history/${id}`);
          const result = await response.json();

          document.getElementById("progressSection").classList.remove("active");

          if (result.code === 200) {
            showResult(result.data);
          } else {
            showError(result.message || "åŠ è½½å¤±è´¥");
          }
        } catch (error) {
          document.getElementById("progressSection").classList.remove("active");
          showError("ç½‘ç»œé”™è¯¯: " + error.message);
        }
      }

      // åˆ é™¤å†å²è®°å½•
      async function deleteHistory(id) {
        if (
          !confirm(
            "ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ\nåˆ é™¤åå°†åŒæ—¶åˆ é™¤æ‰€æœ‰å…³è”çš„å›¾ç‰‡æ–‡ä»¶ã€‚"
          )
        ) {
          return;
        }

        try {
          const response = await fetch(`/api/document/history/${id}`, {
            method: "DELETE",
          });
          const result = await response.json();

          if (result.code === 200) {
            alert("âœ… åˆ é™¤æˆåŠŸ");

            // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰æ˜¾ç¤ºçš„è®°å½•ï¼Œæ¸…ç©ºç»“æœåŒºåŸŸ
            if (currentHistoryId === id) {
              document
                .getElementById("resultSection")
                .classList.remove("active");
              currentHistoryId = null;
            }

            // é‡æ–°åŠ è½½å†å²åˆ—è¡¨
            loadHistoryList();
          } else {
            alert("âŒ åˆ é™¤å¤±è´¥: " + result.message);
          }
        } catch (error) {
          alert("âŒ åˆ é™¤å¤±è´¥: " + error.message);
        }
      }

      // æ ¼å¼åŒ–æ—¶é—´
      function formatTime(timestamp) {
        const date = new Date(timestamp);
        const now = new Date();
        const diff = now - date;

        // å°äº1åˆ†é’Ÿ
        if (diff < 60000) {
          return "åˆšåˆš";
        }
        // å°äº1å°æ—¶
        if (diff < 3600000) {
          return Math.floor(diff / 60000) + "åˆ†é’Ÿå‰";
        }
        // å°äº24å°æ—¶
        if (diff < 86400000) {
          return Math.floor(diff / 3600000) + "å°æ—¶å‰";
        }
        // å°äº7å¤©
        if (diff < 604800000) {
          return Math.floor(diff / 86400000) + "å¤©å‰";
        }

        // è¶…è¿‡7å¤©æ˜¾ç¤ºå…·ä½“æ—¥æœŸ
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, "0");
        const day = String(date.getDate()).padStart(2, "0");
        const hour = String(date.getHours()).padStart(2, "0");
        const minute = String(date.getMinutes()).padStart(2, "0");

        return `${year}-${month}-${day} ${hour}:${minute}`;
      }

      // HTMLè½¬ä¹‰
      function escapeHtml(text) {
        const map = {
          "&": "&amp;",
          "<": "&lt;",
          ">": "&gt;",
          '"': "&quot;",
          "'": "&#039;",
        };
        return text.replace(/[&<>"']/g, (m) => map[m]);
      }

      // File upload area
      const uploadArea = document.getElementById("uploadArea");
      const fileInput = document.getElementById("fileInput");

      uploadArea.addEventListener("click", () => fileInput.click());

      fileInput.addEventListener("change", function (e) {
        handleFileSelect(e.target.files[0]);
      });

      // Drag and drop
      uploadArea.addEventListener("dragover", (e) => {
        e.preventDefault();
        uploadArea.classList.add("drag-over");
      });

      uploadArea.addEventListener("dragleave", () => {
        uploadArea.classList.remove("drag-over");
      });

      uploadArea.addEventListener("drop", (e) => {
        e.preventDefault();
        uploadArea.classList.remove("drag-over");
        const file = e.dataTransfer.files[0];
        handleFileSelect(file);
      });

      function handleFileSelect(file) {
        if (!file) return;

        document.getElementById("fileName").textContent = file.name;
        document.getElementById("fileSize").textContent =
          (file.size / 1024 / 1024).toFixed(2) + " MB";
        document.getElementById("fileInfo").style.display = "block";
        fileInput.files = createFileList(file);
      }

      function createFileList(file) {
        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(file);
        return dataTransfer.files;
      }

      let progressInterval = null;

      async function uploadFile() {
        const file = fileInput.files[0];
        if (!file) {
          showError("è¯·å…ˆé€‰æ‹©æ–‡ä»¶");
          return;
        }

        const formData = new FormData();
        formData.append("file", file);

        document.getElementById("startParseBtn").disabled = true;
        document.getElementById("progressSection").classList.add("active");
        document.getElementById("errorMsg").classList.remove("active");

        // å¯åŠ¨è¿›åº¦æ¡åŠ¨ç”»
        startProgressAnimation();

        try {
          const response = await fetch("/api/document/parse", {
            method: "POST",
            body: formData,
          });

          const result = await response.json();

          if (result.code === 200) {
            // å®Œæˆè¿›åº¦åˆ° 100%
            setProgress(100);
            setTimeout(() => {
              showResult(result.data);
              // åˆ·æ–°å†å²è®°å½•åˆ—è¡¨
              loadHistoryList();
            }, 500);
          } else {
            showError(result.message || "è§£æå¤±è´¥");
          }
        } catch (error) {
          showError("ç½‘ç»œé”™è¯¯: " + error.message);
        } finally {
          stopProgressAnimation();
          document.getElementById("startParseBtn").disabled = false;
          setTimeout(() => {
            document
              .getElementById("progressSection")
              .classList.remove("active");
          }, 1000);
        }
      }

      function startProgressAnimation() {
        let progress = 0;
        const progressFill = document.getElementById("progressFill");
        const progressText = document.getElementById("progressText");

        // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
        if (progressInterval) {
          clearInterval(progressInterval);
        }

        setProgress(0);

        // æ¨¡æ‹Ÿè¿›åº¦å¢é•¿
        progressInterval = setInterval(() => {
          if (progress < 90) {
            // å‰ 90% æ…¢é€Ÿå¢é•¿
            progress += Math.random() * 2;
            setProgress(progress);

            // éšæœºæ›´æ–°æç¤ºæ–‡æœ¬
            const messages = [
              "æ­£åœ¨ä¸Šä¼ æ–‡æ¡£...",
              "æ­£åœ¨è§£ææ–‡æ¡£...",
              "æ­£åœ¨æå–å†…å®¹...",
              "æ­£åœ¨å¤„ç†å›¾ç‰‡...",
              "æ­£åœ¨è½¬æ¢æ ¼å¼...",
            ];
            const randomMsg =
              messages[Math.floor(Math.random() * messages.length)];
            progressText.textContent = randomMsg;
          }
        }, 800);
      }

      function stopProgressAnimation() {
        if (progressInterval) {
          clearInterval(progressInterval);
          progressInterval = null;
        }
      }

      function setProgress(percent) {
        const progressFill = document.getElementById("progressFill");
        progressFill.style.width = percent + "%";
      }

      function showResult(data) {
        currentMarkdown = data.markdownContent;
        currentFilename = data.originalFilename;

        // Update stats
        document.getElementById("imageCount").textContent = data.imageCount;
        document.getElementById("processingTime").textContent =
          (data.processingTime / 1000).toFixed(1) + "s";
        document.getElementById("fileNameDisplay").textContent =
          data.originalFilename.substring(0, 20) +
          (data.originalFilename.length > 20 ? "..." : "");

        // Render markdown
        document.getElementById("markdownPreview").innerHTML = marked.parse(
          data.markdownContent
        );
        document.getElementById("markdownSource").textContent =
          data.markdownContent;

        // Show result section
        document.getElementById("resultSection").classList.add("active");

        // Reset upload area
        document.getElementById("fileInfo").style.display = "none";
        fileInput.value = "";
      }

      function showError(message) {
        const errorMsg = document.getElementById("errorMsg");
        errorMsg.textContent = "âŒ " + message;
        errorMsg.classList.add("active");
      }

      function switchTab(tab) {
        // Remove active from all tabs
        document
          .querySelectorAll(".tab")
          .forEach((t) => t.classList.remove("active"));
        document
          .querySelectorAll(".tab-content")
          .forEach((c) => c.classList.remove("active"));

        // Add active to selected tab
        event.target.classList.add("active");

        if (tab === "preview") {
          document.getElementById("previewTab").classList.add("active");
        } else {
          document.getElementById("sourceTab").classList.add("active");
        }
      }

      function copyMarkdown() {
        navigator.clipboard.writeText(currentMarkdown).then(() => {
          alert("âœ… Markdown å·²å¤åˆ¶åˆ°å‰ªè´´æ¿");
        });
      }

      function downloadMarkdown() {
        const blob = new Blob([currentMarkdown], { type: "text/markdown" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = currentFilename.replace(/\.[^/.]+$/, "") + ".md";
        a.click();
        URL.revokeObjectURL(url);
      }

      // ==================== é…ç½®ç®¡ç† ====================

      // åŠ è½½å½“å‰é…ç½®
      async function loadConfig() {
        try {
          const response = await fetch("/api/document/config");
          const result = await response.json();

          if (result.code === 200 && result.data) {
            currentConfig = result.data;
            updateConfigUI();
          }
        } catch (error) {
          console.error("åŠ è½½é…ç½®å¤±è´¥:", error);
        }
      }

      // æ›´æ–°é…ç½®UIæ˜¾ç¤º
      function updateConfigUI() {
        // æ›´æ–°è§£æå™¨é€‰æ‹©
        document.querySelectorAll("[data-parser]").forEach((option) => {
          if (option.dataset.parser === currentConfig.parserType) {
            option.classList.add("active");
          } else {
            option.classList.remove("active");
          }
        });

        // æ›´æ–°å­˜å‚¨æ–¹å¼é€‰æ‹©
        document.querySelectorAll("[data-storage]").forEach((option) => {
          if (option.dataset.storage === currentConfig.imageStorage) {
            option.classList.add("active");
          } else {
            option.classList.remove("active");
          }
        });
      }

      // é€‰æ‹©è§£æå™¨
      async function selectParser(parserType) {
        if (currentConfig.parserType === parserType) {
          return; // å·²ç»æ˜¯å½“å‰é€‰æ‹©
        }

        try {
          const response = await fetch("/api/document/config", {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              parserType: parserType,
              imageStorage: currentConfig.imageStorage,
            }),
          });

          const result = await response.json();

          if (result.code === 200) {
            currentConfig = result.data;
            updateConfigUI();

            // æ˜¾ç¤ºæˆåŠŸæç¤º
            const parserName = parserType === "mineru" ? "MinerU" : "é˜¿é‡Œäº‘";
            showSuccessToast(`âœ… å·²åˆ‡æ¢åˆ° ${parserName} è§£æå™¨`);
          } else {
            alert("âŒ åˆ‡æ¢å¤±è´¥: " + result.message);
          }
        } catch (error) {
          alert("âŒ åˆ‡æ¢å¤±è´¥: " + error.message);
        }
      }

      // é€‰æ‹©å­˜å‚¨æ–¹å¼
      async function selectStorage(imageStorage) {
        if (currentConfig.imageStorage === imageStorage) {
          return; // å·²ç»æ˜¯å½“å‰é€‰æ‹©
        }

        try {
          const response = await fetch("/api/document/config", {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              parserType: currentConfig.parserType,
              imageStorage: imageStorage,
            }),
          });

          const result = await response.json();

          if (result.code === 200) {
            currentConfig = result.data;
            updateConfigUI();

            // æ˜¾ç¤ºæˆåŠŸæç¤º
            const storageName =
              imageStorage === "github" ? "GitHub" : "é˜¿é‡Œäº‘OSS";
            showSuccessToast(`âœ… å·²åˆ‡æ¢åˆ° ${storageName} å­˜å‚¨`);
          } else {
            alert("âŒ åˆ‡æ¢å¤±è´¥: " + result.message);
          }
        } catch (error) {
          alert("âŒ åˆ‡æ¢å¤±è´¥: " + error.message);
        }
      }

      // æ˜¾ç¤ºæˆåŠŸæç¤º
      function showSuccessToast(message) {
        // åˆ›å»ºæç¤ºå…ƒç´ 
        const toast = document.createElement("div");
        toast.textContent = message;
        toast.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          background: rgba(74, 222, 128, 0.9);
          color: white;
          padding: 15px 25px;
          border-radius: 12px;
          font-size: 0.95rem;
          font-weight: 600;
          box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
          z-index: 10000;
          animation: slideIn 0.3s ease;
        `;

        document.body.appendChild(toast);

        // 3ç§’åç§»é™¤
        setTimeout(() => {
          toast.style.animation = "slideOut 0.3s ease";
          setTimeout(() => {
            document.body.removeChild(toast);
          }, 300);
        }, 3000);
      }

      // æ·»åŠ åŠ¨ç”»æ ·å¼
      const style = document.createElement("style");
      style.textContent = `
        @keyframes slideIn {
          from {
            transform: translateX(400px);
            opacity: 0;
          }
          to {
            transform: translateX(0);
            opacity: 1;
          }
        }
        @keyframes slideOut {
          from {
            transform: translateX(0);
            opacity: 1;
          }
          to {
            transform: translateX(400px);
            opacity: 0;
          }
        }
      `;
      document.head.appendChild(style);
    </script>
  </body>
</html>
