<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAG çŸ¥è¯†åº“å¯¹è¯</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ¤–</text></svg>">
    <style>
        /* è‡ªå®šä¹‰å­—ä½“å®šä¹‰ */
        @font-face {
            font-family: '1666963922';
            src: url('https://jsd.cdn.zzko.cn/gh/54ayao/ACG@main/static/fonts/1666963922.woff') format('woff');
            font-weight: normal;
            font-style: normal;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: '1666963922', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-image: url('https://ipgeo-bingpic.hf.space');
            background-attachment: fixed;
            background-size: cover;
            background-position: center center;
            background-repeat: no-repeat;
            min-height: 100vh;
            color: #333;
            overflow-x: hidden;
            overflow-y: auto;
        }

        /* èƒŒæ™¯é®ç½©å±‚ */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.2);
            z-index: 0;
        }

        .container {
            position: relative;
            z-index: 1;
            max-width: 1600px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        /* Header */
        header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            background-image: linear-gradient(90deg, #07c160, #fb6bea 25%, #3aedff 50%, #fb6bea 75%, #28d079);
            -webkit-text-fill-color: transparent;
            -webkit-background-clip: text;
            background-clip: text;
            background-size: 400% 100%;
            animation: gradientMove 10s linear infinite;
        }

        header p {
            font-size: 1.1rem;
            color: white;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        header .author {
            margin-top: 10px;
            font-size: 0.95rem;
            background-image: linear-gradient(90deg, #07c160, #fb6bea 25%, #3aedff 50%, #fb6bea 75%, #28d079);
            -webkit-text-fill-color: transparent;
            -webkit-background-clip: text;
            background-clip: text;
            background-size: 400% 100%;
            animation: gradientMove 10s linear infinite;
        }

        @keyframes gradientMove {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Main Layout - ä¸¤æ å¸ƒå±€ */
        .main-layout {
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 20px;
            align-items: start;
        }

        /* SVG Filters for Liquid Glass Effect */
        svg.filters {
            position: absolute;
            width: 0;
            height: 0;
        }

        /* Glass Card Base */
        .glass-card {
            position: relative;
            overflow: hidden;
            border-radius: 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .glass-effect {
            position: absolute;
            z-index: 0;
            inset: 0;
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.15);
            filter: url(#glass-distortion);
        }

        .glass-tint {
            position: absolute;
            z-index: 1;
            inset: 0;
            background: rgba(255, 255, 255, 0.1);
        }

        .glass-shine {
            position: absolute;
            inset: 0;
            z-index: 2;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 24px;
        }

        .glass-content {
            position: relative;
            z-index: 3;
            padding: 25px;
        }

        /* å·¦ä¾§ï¼šçŸ¥è¯†åº“ç®¡ç†é¢æ¿ */
        .kb-panel {
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }

        .kb-panel::-webkit-scrollbar {
            width: 6px;
        }

        .kb-panel::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }

        .kb-panel::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
        }

        .panel-title {
            color: white;
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .btn {
            background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(74, 222, 128, 0.3);
            width: 100%;
            margin-bottom: 15px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(74, 222, 128, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }

        .btn-danger:hover {
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
        }

        .kb-list {
            margin-top: 20px;
        }

        .kb-item {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .kb-item:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateX(5px);
        }

        .kb-item.active {
            border-color: #4ade80;
            background: rgba(74, 222, 128, 0.2);
        }

        .kb-item-name {
            color: white;
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 1rem;
        }

        .kb-item-meta {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.85rem;
        }

        .upload-area {
            border: 2px dashed rgba(255, 255, 255, 0.5);
            border-radius: 12px;
            padding: 30px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.1);
            margin-bottom: 15px;
        }

        .upload-area:hover {
            border-color: rgba(255, 255, 255, 0.8);
            background: rgba(255, 255, 255, 0.2);
        }

        .upload-text {
            color: white;
            font-size: 0.95rem;
        }

        .file-input {
            display: none;
        }

        /* ä¸­é—´ï¼šå¯¹è¯åŒºåŸŸ */
        .chat-panel {
            min-height: 600px;
            display: flex;
            flex-direction: column;
        }

        .chat-messages {
            flex: 1;
            min-height: 400px;
            max-height: 600px;
            overflow-y: auto;
            padding: 20px;
            margin-bottom: 20px;
        }

        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
        }

        .message {
            margin-bottom: 20px;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message-user {
            text-align: right;
        }

        .message-content {
            display: inline-block;
            max-width: 80%;
            padding: 15px 20px;
            border-radius: 16px;
            word-wrap: break-word;
        }

        .message-user .message-content {
            background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
            color: white;
        }

        .message-assistant .message-content {
            background: white;
            color: #333;
            text-align: left;
        }

        .message-content img {
            max-width: 100%;
            height: auto;
            border-radius: 12px;
            margin: 15px 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transition: transform 0.3s ease;
            cursor: pointer;
        }

        .message-content img:hover {
            transform: scale(1.02);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
        }

        /* Markdown å†…å®¹æ ·å¼ä¼˜åŒ– */
        .message-content p {
            margin: 8px 0;
            line-height: 1.6;
        }

        .message-content a {
            color: #4ade80;
            text-decoration: none;
            transition: color 0.2s;
        }

        .message-content a:hover {
            color: #22c55e;
            text-decoration: underline;
        }

        .message-content code {
            background: rgba(0, 0, 0, 0.05);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
        }

        .message-content pre {
            background: rgba(0, 0, 0, 0.05);
            padding: 12px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 10px 0;
        }

        .message-content pre code {
            background: none;
            padding: 0;
        }

        .chat-input-area {
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 15px 20px;
            border-radius: 12px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.9);
            font-size: 1rem;
            outline: none;
        }

        .chat-input:focus {
            border-color: #4ade80;
        }

        .send-btn {
            padding: 15px 30px;
            background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .send-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(74, 222, 128, 0.4);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* å³ä¾§ï¼šå†å²è®°å½•é¢æ¿ */
        /* å“åº”å¼è®¾è®¡ */        /* Modal å¼¹çª— */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
        }

        .modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #ddd;
            font-size: 1rem;
        }

        .form-input:focus {
            outline: none;
            border-color: #4ade80;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .empty-state {
            text-align: center;
            color: rgba(255, 255, 255, 0.6);
            padding: 40px 20px;
            font-size: 0.95rem;
        }

        .loading {
            text-align: center;
            color: white;
            padding: 20px;
        }

        .error-msg {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.5);
            color: white;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
            display: none;
        }

        .error-msg.active {
            display: block;
        }

        /* å›¾ç‰‡é¢„è§ˆæ¨¡æ€æ¡† */
        .image-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            justify-content: center;
            align-items: center;
            cursor: pointer;
        }

        .image-modal.active {
            display: flex;
        }

        .image-modal img {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .main-layout {
                grid-template-columns: 280px 1fr 280px;
            }
        }

        @media (max-width: 992px) {
            .main-layout {
                grid-template-columns: 1fr;
            }

            .kb-panel {
                max-height: 400px;
            }
        }
    </style>
</head>
<body>
    <!-- SVG Filters for Liquid Glass Effect -->
    <svg class="filters">
        <filter id="glass-distortion" x="0%" y="0%" width="100%" height="100%">
            <feTurbulence type="fractalNoise" baseFrequency="0.01 0.01" numOctaves="1" seed="5" result="turbulence"/>
            <feComponentTransfer in="turbulence" result="mapped">
                <feFuncR type="gamma" amplitude="1" exponent="10" offset="0.5"/>
                <feFuncG type="gamma" amplitude="0" exponent="1" offset="0"/>
                <feFuncB type="gamma" amplitude="0" exponent="1" offset="0.5"/>
            </feComponentTransfer>
            <feGaussianBlur in="turbulence" stdDeviation="3" result="softMap"/>
            <feSpecularLighting in="softMap" surfaceScale="5" specularConstant="1" specularExponent="100" lighting-color="white" result="specLight">
                <fePointLight x="-200" y="-200" z="300"/>
            </feSpecularLighting>
            <feComposite in="specLight" operator="arithmetic" k1="0" k2="1" k3="1" k4="0" result="litImage"/>
            <feDisplacementMap in="SourceGraphic" in2="softMap" scale="150" xChannelSelector="R" yChannelSelector="G"/>
        </filter>
    </svg>

    <div class="container">
        <!-- Header -->
        <header>
            <h1>RAG çŸ¥è¯†åº“å¯¹è¯</h1>
            <p>é˜¿é‡Œäº‘ç™¾ç‚¼é©±åŠ¨ Â· æ™ºèƒ½é—®ç­” Â· æ–‡æ¡£æ£€ç´¢</p>
            <div class="author">Created by ZHONG WEI</div>
        </header>

        <div class="main-layout">
            <!-- å·¦ä¾§ï¼šçŸ¥è¯†åº“ç®¡ç† -->
            <div class="glass-card kb-panel">
                <div class="glass-effect"></div>
                <div class="glass-tint"></div>
                <div class="glass-shine"></div>
                <div class="glass-content">
                    <div class="panel-title">çŸ¥è¯†åº“ç®¡ç†</div>

                    <div class="error-msg" id="kbError"></div>

                    <button class="btn" onclick="showCreateKbModal()">åˆ›å»ºçŸ¥è¯†åº“</button>
                    <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                        <div class="upload-text">ä¸Šä¼ æ–‡æ¡£åˆ°çŸ¥è¯†åº“</div>
                        <input type="file" id="fileInput" class="file-input" accept=".pdf,.doc,.docx,.ppt,.pptx" onchange="uploadDocument()">
                    </div>

                    <div id="kbList" class="kb-list">
                        <div class="empty-state">æš‚æ— çŸ¥è¯†åº“</div>
                    </div>
                </div>
            </div>

            <!-- ä¸­é—´ï¼šå¯¹è¯åŒºåŸŸ -->
            <div class="glass-card chat-panel">
                <div class="glass-effect"></div>
                <div class="glass-tint"></div>
                <div class="glass-shine"></div>
                <div class="glass-content" style="height: 100%; display: flex; flex-direction: column;">
                    <div class="panel-title">å¯¹è¯åŒºåŸŸ</div>

                    <div class="error-msg" id="chatError"></div>

                    <div id="chatMessages" class="chat-messages">
                        <div class="empty-state">è¯·å…ˆé€‰æ‹©æˆ–åˆ›å»ºçŸ¥è¯†åº“ï¼Œç„¶åå¼€å§‹å¯¹è¯</div>
                    </div>

                    <div class="chat-input-area">
                        <input type="text" id="chatInput" class="chat-input" placeholder="è¾“å…¥ä½ çš„é—®é¢˜..." disabled>
                        <button id="sendBtn" class="send-btn" onclick="sendMessage()" disabled>å‘é€</button>
                    </div>
                </div>
            </div>

            </div>
        </div>
    </div>
        </div>
    </div>

    <!-- åˆ›å»ºçŸ¥è¯†åº“ Modal -->
    <div id="createKbModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">åˆ›å»ºçŸ¥è¯†åº“</div>
            <div class="form-group">
                <label class="form-label">çŸ¥è¯†åº“åç§°</label>
                <input type="text" id="kbName" class="form-input" placeholder="è¯·è¾“å…¥çŸ¥è¯†åº“åç§°">
            </div>
            <div class="form-group">
                <label class="form-label">æè¿°ï¼ˆå¯é€‰ï¼‰</label>
                <input type="text" id="kbDescription" class="form-input" placeholder="è¯·è¾“å…¥æè¿°">
            </div>
            <div class="modal-buttons">
                <button class="btn" onclick="createKnowledgeBase()">åˆ›å»º</button>
                <button class="btn btn-danger" onclick="closeCreateKbModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- å›¾ç‰‡é¢„è§ˆæ¨¡æ€æ¡† -->
    <div id="imageModal" class="image-modal" onclick="closeImageModal()">
        <img id="modalImage" src="" alt="é¢„è§ˆå›¾ç‰‡">
    </div>

    <!-- Marked.js for Markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script>
        // Configure marked
        marked.setOptions({
            breaks: true,
            gfm: true,
            headerIds: true,
            mangle: false,
            sanitize: false
        });

        let currentKnowledgeBase = null;

        // é¡µé¢åŠ è½½æ—¶è·å–çŸ¥è¯†åº“åˆ—è¡¨
        window.addEventListener('load', function() {
            loadKnowledgeBases();
        });

        // æ˜¾ç¤ºåˆ›å»ºçŸ¥è¯†åº“å¼¹çª—
        function showCreateKbModal() {
            document.getElementById('createKbModal').classList.add('active');
        }

        // å…³é—­åˆ›å»ºçŸ¥è¯†åº“å¼¹çª—
        function closeCreateKbModal() {
            document.getElementById('createKbModal').classList.remove('active');
            document.getElementById('kbName').value = '';
            document.getElementById('kbDescription').value = '';
        }

        // åˆ›å»ºçŸ¥è¯†åº“
        async function createKnowledgeBase() {
            const name = document.getElementById('kbName').value.trim();
            if (!name) {
                showError('kbError', 'è¯·è¾“å…¥çŸ¥è¯†åº“åç§°');
                return;
            }

            const description = document.getElementById('kbDescription').value.trim();

            try {
                const formData = new FormData();
                formData.append('name', name);
                if (description) {
                    formData.append('description', description);
                }

                const response = await fetch('/api/knowledge-base/create', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.code === 200) {
                    closeCreateKbModal();
                    loadKnowledgeBases();
                    alert('çŸ¥è¯†åº“åˆ›å»ºæˆåŠŸï¼');
                } else {
                    showError('kbError', result.message || 'åˆ›å»ºå¤±è´¥');
                }
            } catch (error) {
                showError('kbError', 'ç½‘ç»œé”™è¯¯: ' + error.message);
            }
        }

        // åŠ è½½çŸ¥è¯†åº“åˆ—è¡¨
        async function loadKnowledgeBases() {
            try {
                const response = await fetch('/api/knowledge-base/list');
                const result = await response.json();

                if (result.code === 200 && result.data) {
                    renderKnowledgeBases(result.data);
                }
            } catch (error) {
                showError('kbError', 'åŠ è½½çŸ¥è¯†åº“åˆ—è¡¨å¤±è´¥');
            }
        }

        // æ¸²æŸ“çŸ¥è¯†åº“åˆ—è¡¨
        function renderKnowledgeBases(knowledgeBases) {
            const kbList = document.getElementById('kbList');

            if (knowledgeBases.length === 0) {
                kbList.innerHTML = '<div class="empty-state">æš‚æ— çŸ¥è¯†åº“</div>';
                return;
            }

            kbList.innerHTML = knowledgeBases.map(kb => `
                <div class="kb-item ${currentKnowledgeBase && currentKnowledgeBase.id === kb.id ? 'active' : ''}" onclick="selectKnowledgeBase('${kb.id}', '${escapeHtml(kb.name)}')">
                    <div class="kb-item-name">${escapeHtml(kb.name)}</div>
                </div>
            `).join('');
        }

        // é€‰æ‹©çŸ¥è¯†åº“
        function selectKnowledgeBase(id, name) {
            currentKnowledgeBase = { id, name };

            // æ›´æ–° UI
            document.querySelectorAll('.kb-item').forEach(item => item.classList.remove('active'));
            event.target.closest('.kb-item').classList.add('active');

            // å¯ç”¨å¯¹è¯è¾“å…¥
            document.getElementById('chatInput').disabled = false;
            document.getElementById('sendBtn').disabled = false;

            // æ¸…ç©ºå¯¹è¯
            document.getElementById('chatMessages').innerHTML = '<div class="empty-state">å·²é€‰æ‹©çŸ¥è¯†åº“: ' + escapeHtml(name) + '<br>å¼€å§‹å¯¹è¯å§ï¼</div>';
        }

        // ä¸Šä¼ æ–‡æ¡£
        async function uploadDocument() {
            if (!currentKnowledgeBase) {
                showError('kbError', 'è¯·å…ˆé€‰æ‹©çŸ¥è¯†åº“');
                return;
            }

            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];

            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);

            try {
                showError('kbError', 'æ­£åœ¨ä¸Šä¼ å¹¶è½¬æ¢æ–‡æ¡£ï¼Œè¯·ç¨å€™...');

                const response = await fetch(`/api/knowledge-base/${currentKnowledgeBase.id}/upload`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.code === 200) {
                    hideError('kbError');
                    alert('æ–‡æ¡£ä¸Šä¼ æˆåŠŸï¼');
                    loadKnowledgeBases();
                } else {
                    showError('kbError', result.message || 'ä¸Šä¼ å¤±è´¥');
                }
            } catch (error) {
                showError('kbError', 'ç½‘ç»œé”™è¯¯: ' + error.message);
            } finally {
                fileInput.value = '';
            }
        }

        // å‘é€æ¶ˆæ¯ï¼ˆæµå¼ï¼‰
        async function sendMessage() {
            if (!currentKnowledgeBase) {
                showError('chatError', 'è¯·å…ˆé€‰æ‹©çŸ¥è¯†åº“');
                return;
            }

            const input = document.getElementById('chatInput');
            const question = input.value.trim();

            if (!question) return;

            // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
            appendMessage('user', question);
            input.value = '';

            // ç¦ç”¨è¾“å…¥
            document.getElementById('sendBtn').disabled = true;
            document.getElementById('chatInput').disabled = true;

            // åˆ›å»ºä¸€ä¸ªç©ºçš„åŠ©æ‰‹æ¶ˆæ¯å®¹å™¨
            const assistantMessageDiv = createStreamingMessage();
            let streamEnded = false;

            try {
                const response = await fetch('/api/rag-chat/send', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'text/event-stream'
                    },
                    body: JSON.stringify({
                        knowledgeBaseId: currentKnowledgeBase.id,
                        question: question
                    })
                });

                if (!response.ok) {
                    throw new Error('è¯·æ±‚å¤±è´¥: ' + response.status);
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                while (!streamEnded) {
                    const { done, value } = await reader.read();

                    if (done) {
                        streamEnded = true;
                        break;
                    }

                    // è§£ç æ•°æ®
                    buffer += decoder.decode(value, { stream: true });

                    // SSE äº‹ä»¶ä»¥åŒæ¢è¡Œç¬¦åˆ†éš”
                    const events = buffer.split('\n\n');
                    buffer = events.pop() || ''; // ä¿ç•™ä¸å®Œæ•´çš„äº‹ä»¶

                    for (const event of events) {
                        if (!event.trim()) continue;

                        const lines = event.split('\n');
                        let eventName = '';
                        let eventData = '';

                        for (const line of lines) {
                            if (line.startsWith('event:')) {
                                eventName = line.substring(6).trim();
                            } else if (line.startsWith('data:')) {
                                eventData = line.substring(5).trim();
                            }
                        }

                        // å¤„ç†äº‹ä»¶
                        if (eventName === 'done' || eventData === '[DONE]') {
                            streamEnded = true;
                            break;
                        }

                        if (eventName === 'error') {
                            showError('chatError', eventData);
                            streamEnded = true;
                            break;
                        }

                        if (eventData && eventData !== '' && eventData !== '[DONE]') {
                            // è¿½åŠ å†…å®¹åˆ°æ¶ˆæ¯
                            appendStreamingContent(assistantMessageDiv, eventData);
                        }
                    }

                    if (streamEnded) {
                        break;
                    }
                }

            } catch (error) {
                showError('chatError', 'ç½‘ç»œé”™è¯¯: ' + error.message);
                // ç§»é™¤æœªå®Œæˆçš„æ¶ˆæ¯
                if (assistantMessageDiv && assistantMessageDiv.parentNode) {
                    assistantMessageDiv.parentNode.remove();
                }
            } finally {
                // ç¡®ä¿å¯ç”¨è¾“å…¥
                document.getElementById('sendBtn').disabled = false;
                document.getElementById('chatInput').disabled = false;
            }
        }

        // åˆ›å»ºæµå¼æ¶ˆæ¯å®¹å™¨
        function createStreamingMessage() {
            const messagesDiv = document.getElementById('chatMessages');

            // ç§»é™¤ç©ºçŠ¶æ€æç¤º
            const emptyState = messagesDiv.querySelector('.empty-state');
            if (emptyState) {
                emptyState.remove();
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = 'message message-assistant';

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.setAttribute('data-raw-content', ''); // å­˜å‚¨åŸå§‹å†…å®¹

            messageDiv.appendChild(contentDiv);
            messagesDiv.appendChild(messageDiv);

            // æ»šåŠ¨åˆ°åº•éƒ¨
            messagesDiv.scrollTop = messagesDiv.scrollHeight;

            return contentDiv;
        }

        // è¿½åŠ æµå¼å†…å®¹
        function appendStreamingContent(contentDiv, chunk) {
            // è·å–å½“å‰åŸå§‹å†…å®¹
            let rawContent = contentDiv.getAttribute('data-raw-content') || '';
            rawContent += chunk;
            contentDiv.setAttribute('data-raw-content', rawContent);

            // æ¸²æŸ“ Markdown
            contentDiv.innerHTML = marked.parse(rawContent);

            // ä¸ºå›¾ç‰‡æ·»åŠ ç‚¹å‡»äº‹ä»¶
            const images = contentDiv.querySelectorAll('img');
            images.forEach(img => {
                img.addEventListener('click', function(e) {
                    e.stopPropagation();
                    showImageModal(this.src);
                });
            });

            // æ»šåŠ¨åˆ°åº•éƒ¨
            const messagesDiv = document.getElementById('chatMessages');
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // æ·»åŠ æ¶ˆæ¯åˆ°å¯¹è¯åŒºåŸŸ
        function appendMessage(role, content) {
            const messagesDiv = document.getElementById('chatMessages');

            // ç§»é™¤ç©ºçŠ¶æ€æç¤º
            const emptyState = messagesDiv.querySelector('.empty-state');
            if (emptyState) {
                emptyState.remove();
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = `message message-${role}`;

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';

            if (role === 'assistant') {
                // ç›´æ¥æ¸²æŸ“ Markdownï¼ˆå†…å®¹å·²åŒ…å«å›¾ç‰‡è¯­æ³•ï¼‰
                contentDiv.innerHTML = marked.parse(content);
            } else {
                contentDiv.textContent = content;
            }

            messageDiv.appendChild(contentDiv);
            messagesDiv.appendChild(messageDiv);

            // ä¸ºå›¾ç‰‡æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼ˆæ”¾å¤§é¢„è§ˆï¼‰
            if (role === 'assistant') {
                const images = contentDiv.querySelectorAll('img');
                images.forEach(img => {
                    img.addEventListener('click', function(e) {
                        e.stopPropagation();
                        showImageModal(this.src);
                    });
                });
            }

            // æ»šåŠ¨åˆ°åº•éƒ¨
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
        function showError(elementId, message) {
            const errorDiv = document.getElementById(elementId);
            errorDiv.textContent = 'âŒ ' + message;
            errorDiv.classList.add('active');
        }

        // éšè—é”™è¯¯æ¶ˆæ¯
        function hideError(elementId) {
            const errorDiv = document.getElementById(elementId);
            errorDiv.classList.remove('active');
        }

        // æ˜¾ç¤ºå›¾ç‰‡é¢„è§ˆ
        function showImageModal(imageSrc) {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            modalImg.src = imageSrc;
            modal.classList.add('active');
        }

        // å…³é—­å›¾ç‰‡é¢„è§ˆ
        function closeImageModal() {
            const modal = document.getElementById('imageModal');
            modal.classList.remove('active');
        }

        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleString('zh-CN');
        }

        // HTML è½¬ä¹‰
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // å›è½¦å‘é€æ¶ˆæ¯
        document.getElementById('chatInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
    </script>
</body>
</html>
